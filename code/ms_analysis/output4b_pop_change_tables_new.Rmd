---
title: "Changes table"
output: word_document
date: "`r Sys.Date()`"
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      error = FALSE,
                      fig.width = 7,
                      fig.height = 9)
```



```{r}
library(tidyverse)
library(birdnames)
library(here)
library(flextable)
library(ftExtra)
library(officer)

#source_url("https://raw.githubusercontent.com/scottfjennings/HEP_data_work/master/HEP_code/HEP_utility_functions.R")
#source("C:/Users/scott.jennings/OneDrive - Audubon Canyon Ranch/Projects/core_monitoring_research/HEP/hep_analyses/how_are_the_egrets_doing/code/ms_analysis/hep_trend_utilities.R")
source("C:/Users/scott.jennings/OneDrive - Audubon Canyon Ranch/Projects/core_monitoring_research/HEP/HEP_data_work/HEP_code/HEP_utility_functions.R")

```

```{r}

all_mod_av_preds <- readRDS(here("fitted_models/all_mod_av_preds"))

trend_analysis_table <- readRDS(here("data/trend_analysis_table"))

all_mod_av_preds_per_change <- readRDS(here("fitted_models/all_mod_av_per_change")) # from analysis3_model_ave_estimates.R

```



```{r}

pred_table_start <- all_mod_av_preds %>% 
  group_by(species, subregion) %>% 
  mutate(keep.year = case_when(year == min(year) ~ "first.year",
                               year == max(year) ~ "last.year")) %>% 
  ungroup() %>% 
  filter(!is.na(keep.year)) %>% 
  mutate(across(c(mod.avg.pred, lower.CL, upper.CL), ~round(., 0)),
         out.estimate = paste(mod.avg.pred, " (", lower.CL, ", ", upper.CL, ")", sep = "")) 
 
per_change <- all_mod_av_preds_per_change %>% 
  separate(alpha.code, c("species", "subregion"), sep = "_") %>% 
  mutate(across(c(per.change, per.change.LCI, per.change.UCI, marginal.effect, marginal.lower.CL, marginal.upper.CL), ~round(., 0)),
         out.per.change = paste(per.change, "% (", per.change.LCI, "%, ", per.change.UCI, "%)", sep = ""),
         out.abs.change = paste(marginal.effect, " (", marginal.lower.CL, ", ", marginal.upper.CL, ")", sep = "")) %>%  
  dplyr::select(species, subregion, out.per.change, out.abs.change)
  

pred_table_est <- pred_table_start %>% 
  mutate(keep.year = paste("est.", keep.year, sep = "")) %>% 
  pivot_wider(id_cols = c(species, subregion), names_from = keep.year, values_from = out.estimate)

pred_table_years <- pred_table_start  %>% 
  mutate(year = as.character(year))%>% 
  pivot_wider(id_cols = c(species, subregion), names_from = keep.year, values_from = year)

pred_table <- full_join(pred_table_est, pred_table_years) %>% 
  full_join(subreg_key) %>% 
  full_join(per_change) %>% 
  arrange(species, subreg.name)

write.csv(pred_table, here("output/trend_model_predictions.csv"), row.names = FALSE)



```




```{r}


spp_subreg <- readRDS(here("data/spp_subreg")) %>%
  mutate(species = factor(species, levels = c("GREG", "GBHE", "SNEG", "BCNH"))) %>% 
  full_join(subreg_key) %>% 
  arrange(species, subreg.name) 

```


```{r}


make_spp_tab2 <- function(zspp) {
  ztable <- filter(pred_table, species == zspp) %>% 
    full_join(subreg_key %>% dplyr::select(subreg.name))  %>% 
    arrange(subreg.name) %>% 
    mutate(years.obs = paste(first.year, last.year, sep = "-"),
           years.obs = str_replace(years.obs, "NA-NA", ""),
           break1 = "",
           subreg.name = ifelse(is.na(first.year), paste(subreg.name, "*", sep = ""), as.character(subreg.name))) %>% 
    dplyr::select(subreg.name, years.obs, out.abs.change, out.per.change, est.last.year)
  
  
    flextable(ztable) %>%
    set_header_labels(subreg.name = "Subregion",
                    years.obs = "Years observed nesting",
                    est.last.year = "Final year estimated\nabundance",
                    out.per.change = "% change",
                    out.abs.change = "Absolute change") %>%
    align(j = 2:5, align = "center", part = "all") %>%
    hline_bottom(part = "body") %>%
    fit_to_width(max_width = 8.5) %>% 
    width(j = c(1, 3:5), width = 1.5) %>% 
    width(j = 2, width = 1)
}

```





<br>  


<br>  
Table XX. Changes in estimated number of Great Egret nests by subregion in the San Francisco Bay area, 1995-2019. Shown for each subregion are the years Great Egrets were observed nesting, the absolute and percent change across those years, and the estimated abundance in the final observed year. Estimates are shown with their 95% Confidence Intervals. Subregions marked with “*” and with no values had insufficient data for modeling. 

<br>
<br>
```{r}
make_spp_tab2("GREG")
```

<br>  
<br>  

<br>  


<br>  
Table XX. Changes in estimated number of Great Blue Heron nests by subregion in the San Francisco Bay area, 1995-2019. Shown for each subregion are the years Great Blue Herons were observed nesting, the absolute and percent change across those years, and the estimated abundance in the final observed year. Estimates are shown with their 95% Confidence Intervals. Subregions marked with “*” and with no values had insufficient data for modeling. 
<br>
<br>
```{r}
make_spp_tab2("GBHE")
```

<br>  
<br>  

<br>  


<br>  
Table XX. Changes in estimated number of Snowy Egret nests by subregion in the San Francisco Bay area, 1995-2019. Shown for each subregion are the years Snowy Egrets were observed nesting, the absolute and percent change across those years, and the estimated abundance in the final observed year. Estimates are shown with their 95% Confidence Intervals. Subregions marked with “*” and with no values had insufficient data for modeling. 
<br>
<br>
```{r}
make_spp_tab2("SNEG")
```

<br>  
<br>  

 
<br>  


<br>  
Table XX. Changes in estimated number of Black-crowned Night-Heron nests by subregion in the San Francisco Bay area, 1995-2019. Shown for each subregion are the years Black-crowned Night-Heron were observed nesting, the absolute and percent change across those years, and the estimated abundance in the final observed year. Estimates are shown with their 95% Confidence Intervals. Subregions marked with “*” and with no values had insufficient data for modeling. 
<br>
<br>
```{r}
make_spp_tab2("BCNH")
```
